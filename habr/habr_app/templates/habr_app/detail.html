<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>{{ article.title }}</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f6f8;
        color: #222;
        margin: 0;
        padding: 0;
      }
      header {
        background: #1e88e5;
        color: #fff;
        padding: 15px 30px;
      }
      header h1 {
        margin: 0;
        font-size: 26px;
      }
      .container {
        max-width: 900px;
        margin: 40px auto;
        background: #fff;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .meta {
        font-size: 14px;
        color: #777;
        margin-bottom: 10px;
      }
      img {
        width: 100%;
        max-height: 400px; /* —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–∞ –æ–≥—Ä–æ–º–Ω–æ–π */
        object-fit: cover;
        border-radius: 8px;
        margin: 20px 0;
      }
      .likes {
        margin-top: 20px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 20px;
      }
      .likes span {
        margin-right: 15px;
      }
      .like-btn,
      .dislike-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        margin-right: 10px;
      }
      a.back {
        display: inline-block;
        margin-top: 20px;
        padding: 8px 12px;
        background: #1e88e5;
        color: #fff;
        border-radius: 5px;
        text-decoration: none;
      }
      a.back:hover {
        background: #1565c0;
      }
    </style>
  </head>
  <body>
    {% csrf_token %}
    <header>
      <h1>{{ article.title }}</h1>
    </header>

    <div class="container">
      <div class="meta">
        <b>–ê–≤—Ç–æ—Ä:</b> {{ article.author.username }} | <b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</b> {% if article.category %}{{ article.category.name }}{% else %}–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏{% endif %}
      </div>

      {% if article.image %}
      <img src="{{ article.image.url }}" alt="{{ article.title }}" />
      {% endif %}

      <p>{{ article.content|linebreaks }}</p>

      <div class="likes">
        {% if user.is_authenticated %}
        <button
          id="like-btn"
          class="like-btn"
          data-article-id="{{ article.id }}"
          data-action="like"
          {% if user_like_status == 'like' %}style="opacity: 0.5;"{% endif %}
        >
          üëç {{ article.likes }}
        </button>
        <button
          id="dislike-btn"
          class="dislike-btn"
          data-article-id="{{ article.id }}"
          data-action="dislike"
          {% if user_like_status == 'dislike' %}style="opacity: 0.5;"{% endif %}
        >
          üëé {{ article.dislikes }}
        </button>
        {% else %}
        <span>üëç {{ article.likes }}</span>
        <span>üëé {{ article.dislikes }}</span>
        <p style="color: #777; font-size: 14px">
          –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏
        </p>
        {% endif %}
      </div>

      <a href="{% url 'habr_app:index' %}" class="back">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const likeBtn = document.getElementById("like-btn");
        const dislikeBtn = document.getElementById("dislike-btn");

        function handleLike(action) {
          const articleId = likeBtn.dataset.articleId;
          const url =
            action === "like"
              ? '{% url "habr_app:like_article" 0 %}'.replace("0", articleId)
              : '{% url "habr_app:dislike_article" 0 %}'.replace(
                  "0",
                  articleId
                );

          fetch(url, {
            method: "POST",
            headers: {
              "X-CSRFToken": document.querySelector(
                "[name=csrfmiddlewaretoken]"
              ).value,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({}),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                likeBtn.textContent = `üëç ${data.likes}`;
                dislikeBtn.textContent = `üëé ${data.dislikes}`;
                
                if (data.action === 'added' && action === 'like') {
                  likeBtn.style.opacity = '0.5';
                  dislikeBtn.style.opacity = '1';
                } else if (data.action === 'added' && action === 'dislike') {
                  dislikeBtn.style.opacity = '0.5';
                  likeBtn.style.opacity = '1';
                } else if (data.action === 'removed') {
                  likeBtn.style.opacity = '1';
                  dislikeBtn.style.opacity = '1';
                } else if (data.action === 'changed_to_like') {
                  likeBtn.style.opacity = '0.5';
                  dislikeBtn.style.opacity = '1';
                } else if (data.action === 'changed_to_dislike') {
                  dislikeBtn.style.opacity = '0.5';
                  likeBtn.style.opacity = '1';
                }
              } else {
                console.error("Error:", data.error);
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }

        likeBtn.addEventListener("click", () => handleLike("like"));
        dislikeBtn.addEventListener("click", () => handleLike("dislike"));
      });
    </script>
  </body>
</html>
